@startuml sequence-validation-hours

' Configuration
title Diagramme de SÃ©quence 2: Validation des Heures\net Mise Ã  Jour Automatique du Badge

actor "Organisation" as Org
participant "Frontend React" as Frontend
participant "API Gateway\n(JWT Auth)" as Gateway
participant "OrganizationView\n(Django)" as OrgView
participant "ValidationService\n(Logique MÃ©tier)" as Service
participant "Participation\n(Model)" as Participation
participant "Volunteer\n(Model)" as Volunteer
participant "BadgeCalculator\n(Service)" as BadgeCalc
database "PostgreSQL" as DB

== Contexte Initial ==
note over Org, DB
  **Situation:**
  - Mission terminÃ©e (end_date passÃ©e)
  - BÃ©nÃ©vole: Alice (total_hours=45, badge=BRONZE)
  - Participation: 10h Ã  valider
  - Objectif: Valider heures â†’ Passer SILVER (45+10=55h)
end note

== Authentification ==
Org -> Frontend : Clique sur "Valider 10 heures"
Frontend -> Gateway : POST /api/missions/organization/validate-hours/\n{"participation_id": 123, "hours": 10}\nAuthorization: Bearer <token>
Gateway -> Gateway : VÃ©rifier JWT Token (Organisation)
alt Token invalide ou pas Organisation
  Gateway --> Frontend : 403 Forbidden
  Frontend --> Org : "AccÃ¨s refusÃ©"
else Token valide + Organisation
  Gateway -> OrgView : Request avec user (Organisation)
end

== VÃ©rification PropriÃ©tÃ© ==
OrgView -> Service : validate_hours(participation_id, hours, organization)
Service -> DB : SELECT * FROM participations\nJOIN missions ON participation.mission_id = mission.id\nWHERE participation.id=123
DB --> Service : Participation(id=123, mission.organization=Org,\n volunteer=Alice, status='PENDING')

alt Organisation ne possÃ¨de pas la mission
  Service --> OrgView : PermissionError("Pas votre mission")
  OrgView --> Frontend : 403 Forbidden
  Frontend --> Org : "Cette participation ne vous appartient pas"
else Organisation propriÃ©taire
  Service -> Service : âœ“ Organisation autorisÃ©e
end

== VÃ©rification Date Mission ==
Service -> DB : SELECT end_date FROM missions WHERE id=?
DB --> Service : Mission(end_date='2025-12-20')
Service -> Service : Comparer avec date du jour (2025-12-21)

alt Mission pas encore terminÃ©e
  Service --> OrgView : ValidationError("Mission pas terminÃ©e")
  OrgView --> Frontend : 400 Bad Request
  Frontend --> Org : "Impossible de valider avant la fin"
else Mission terminÃ©e
  Service -> Service : âœ“ Date OK
end

== Transaction Base de DonnÃ©es ==
note over Service, DB
  **Transaction ACID:**
  BEGIN TRANSACTION;
  Toutes les opÃ©rations doivent rÃ©ussir
  ou tout est annulÃ© (rollback)
end note

Service -> DB : BEGIN TRANSACTION

== 1. Mise Ã  jour Participation ==
Service -> Participation : validate(hours=10)
Participation -> DB : UPDATE participations\nSET hours_completed=10,\n status='VALIDATED',\n validated_at=NOW()\nWHERE id=123
DB --> Participation : âœ“ 1 row updated

== 2. RÃ©cupÃ©ration BÃ©nÃ©vole ==
Service -> DB : SELECT * FROM volunteers\nWHERE id=(SELECT volunteer_id FROM participations WHERE id=123)\nFOR UPDATE  -- Lock row
DB --> Service : Volunteer(id=5, total_hours=45,\n completed_missions=7, badge='BRONZE')

== 3. Calcul Nouvelles Statistiques ==
Service -> Service : Calculer nouvelles valeurs
note right
  new_total_hours = 45 + 10 = 55
  new_completed_missions = 7 + 1 = 8
end note

== 4. Calcul Automatique du Badge ==
Service -> BadgeCalc : calculate_badge_level(total_hours=55)
BadgeCalc -> BadgeCalc : Appliquer rÃ¨gles mÃ©tier
note right of BadgeCalc
  **RÃ¨gles Badge:**
  if total_hours < 50:
    return 'BRONZE'
  elif total_hours < 200:
    return 'SILVER'  â† 55h
  else:
    return 'GOLD'
end note
BadgeCalc --> Service : 'SILVER'

== 5. Mise Ã  jour BÃ©nÃ©vole ==
Service -> Volunteer : update_statistics(total_hours=55,\n completed_missions=8,\n badge_level='SILVER')
Volunteer -> DB : UPDATE volunteers\nSET total_hours=55,\n completed_missions=8,\n badge_level='SILVER'\nWHERE id=5
DB --> Volunteer : âœ“ 1 row updated

== 6. Commit Transaction ==
Service -> DB : COMMIT TRANSACTION
DB --> Service : âœ“ Transaction rÃ©ussie

note over Service, DB
  **Toutes les mises Ã  jour atomiques:**
  âœ“ Participation validÃ©e (10h)
  âœ“ BÃ©nÃ©vole: total_hours = 55h
  âœ“ BÃ©nÃ©vole: completed_missions = 8
  âœ“ BÃ©nÃ©vole: badge_level = SILVER
end note

== Notification (Optionnel) ==
Service -> Service : send_notification_to_volunteer()
note right
  Envoyer email/notification:
  "FÃ©licitations! Vos 10 heures ont Ã©tÃ© validÃ©es.
  Vous Ãªtes passÃ© au niveau SILVER! ðŸ¥ˆ"
end note

== RÃ©ponse SuccÃ¨s ==
Service --> OrgView : ValidationResult(success=True,\n new_badge='SILVER')
OrgView --> Frontend : 200 OK\n{"message": "Heures validÃ©es",\n "volunteer": {\n   "total_hours": 55,\n   "badge": "SILVER",\n   "completed_missions": 8\n }}

Frontend --> Org : âœ“ "Heures validÃ©es avec succÃ¨s!\nLe bÃ©nÃ©vole est passÃ© SILVER ðŸ¥ˆ"

== Mise Ã  jour UI ==
Frontend -> Frontend : Actualiser statistiques mission
Frontend -> Frontend : Mettre Ã  jour statut participation

note over Org, DB
  **RÃ¨gles MÃ©tier AppliquÃ©es:**
  âœ“ VÃ©rification propriÃ©tÃ© mission
  âœ“ VÃ©rification date fin mission
  âœ“ Transaction atomique (ACID)
  âœ“ Calcul automatique badge
  âœ“ Mise Ã  jour statistiques
  
  **RÃ©sultat:**
  Alice: 45h (BRONZE) â†’ 55h (SILVER)
end note

@enduml
